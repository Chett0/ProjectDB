<div class="flights-tab">
	<div class="flights-header-row">
		<span class="flights-header-title">Gestione Voli</span>
		<button class="filters-toggle-btn" (click)="toggleFilters()">⚙️ Filtri</button>
		<div class="flights-search-box">
			<input type="text" [formControl]="searchControl" placeholder="Cerca..." class="flights-search-input" />
		</div>
	<button class="add-flight-btn" (click)="openAddFlightModal()">+ Aggiungi Volo</button>
	</div>


	<!-- Lista voli -->
		<!-- Filters panel (uses same filters component as main search) -->
		<div *ngIf="showFilters" class="filters-panel">
			<app-filters-flights (close)="showFilters = false"></app-filters-flights>
		</div>

		<div class="flights-list" *ngIf="filteredFlights && filteredFlights.length">
		<ul>
			<li *ngFor="let f of filteredFlights" class="flight-row">
				<div class="flight-main">
					<div class="route">
						<span class="route-name">
							{{ (f.departureAirport.name || f.departureAirport.city || f.departureAirport.name || f.departureAirport.city || '-') }}
							(<span class="code">{{ f.departureAirport.code || f.departureAirport.code || '-' }}</span>)
							&nbsp;→&nbsp;
							{{ (f.arrivalAirport.name || f.arrivalAirport.city || f.arrivalAirport.name || f.arrivalAirport.city || '-') }}
							(<span class="code">{{ f.arrivalAirport.code || f.arrivalAirport.code || '-' }}</span>)
						</span>
					</div>
					<div class="meta">
						<span class="time">{{ f.departureTime }} - {{ f.arrivalTime }}</span>
						<span class="aircraft">{{ f.aircraft.model }}</span>
						<span class="price">€ {{ f.basePrice }}</span>
					</div>
				</div>
			</li>
		</ul>
	</div>

		<!-- Paginatore -->
		<div class="flights-paginator mt-3" *ngIf="flightsTotal > flightsLimit" style="display:flex;justify-content:center;">
			<div class="d-flex align-items-center">
				<button class="btn btn-sm btn-outline-primary me-2" (click)="prevFlightsPage()" [disabled]="flightsPage <= 1">Prev</button>

				<ng-container *ngFor="let p of getVisibleFlightPages(); let i = index">
					<ng-container *ngIf="p === '...'; else tBtn">
						<span class="mx-1">&hellip;</span>
					</ng-container>
					<ng-template #tBtn>
						<button class="btn btn-sm me-1" [ngClass]="{'btn-primary': flightsPage === (+p), 'btn-outline-secondary': flightsPage !== (+p)}" (click)="setFlightsPage(+p)">{{ p }}</button>
					</ng-template>
				</ng-container>

				<button class="btn btn-sm btn-outline-primary ms-2" (click)="nextFlightsPage()" [disabled]="flightsPage >= getFlightsTotalPages()">Next</button>
			</div>
		</div>

		<!-- Modale per aggiunta volo -->
		<div class="modal" *ngIf="showAddFlightModal">
			<div class="modal-content">
				<span class="close" (click)="closeAddFlightModal()">&times;</span>
				<h2>Aggiungi nuovo volo</h2>
					<form (ngSubmit)="onAddFlightSubmit()" #addFlightForm="ngForm">
							<div *ngIf="routes && routes.length" class="modal-route-dropdown-wrapper modal-aircraft-selection">
								<label class="selector-label">Seleziona rotta per il volo</label>
								<div class="modal-selector-toggle" (click)="toggleModalRoutesDropdown()">
									<span *ngIf="!selectedRouteId">Seleziona rotta...</span>
									<span *ngIf="selectedRouteId">{{ selectedRouteLabel }}</span>
									<span class="caret">▾</span>
								</div>
								<div class="modal-dropdown" *ngIf="showModalRoutesDropdown">
									<input type="text" [formControl]="modalRouteSearchControl" placeholder="Cerca rotta..." class="modal-search-input" />
										<div class="modal-aircraft-list">
											<ul>
												<li *ngFor="let r of modalFilteredRoutes" (click)="selectRoute(r.id); toggleModalRoutesDropdown()" class="compact-item">
													<div class="model">
														<ng-container *ngIf="r; else showRouteCodes">
															({{ r.departureAirport.code }} → {{ r.arrivalAirport.code }})
														</ng-container>
														<ng-template #showRouteCodes>
															{{ r.departureAirport.code || '-' }} → {{ r.arrivalAirport.code || '-' }}
														</ng-template>
													</div>
												</li>
											</ul>
										</div>
								</div>
							</div>
					<label for="departure_time">Data e ora partenza:</label>
					<input type="datetime-local" id="departure_time" name="departure_time" [(ngModel)]="newFlight.departure_time" [min]="minDate" required>

					<label for="arrival_time">Data e ora arrivo:</label>
					<input type="datetime-local" id="arrival_time" name="arrival_time" [(ngModel)]="newFlight.arrival_time" [min]="minDate" required>

					<label for="base_price">Prezzo base:</label>
					<input type="number" id="base_price" name="base_price" [(ngModel)]="newFlight.base_price" step="0.01" required>
					<div *ngIf="aircrafts && aircrafts.length" class="modal-aircraft-dropdown-wrapper">
						<label class="selector-label">Seleziona aereo per il volo</label>
						<div class="modal-selector-toggle" (click)="toggleModalAircraftsDropdown()">
							<span *ngIf="!selectedAircraftId">Seleziona aereo...</span>
							<span *ngIf="selectedAircraftId">{{ selectedAircraftModel }}</span>
							<span class="caret">▾</span>
						</div>
						<div class="modal-dropdown" *ngIf="showModalAircraftsDropdown">
							<input type="text" [formControl]="modalAircraftSearchControl" placeholder="Cerca aereo..." class="modal-search-input" />
							<div class="modal-aircraft-list">
								<ul>
									<li *ngFor="let a of filteredAircrafts" (click)="selectAircraft(a.id); toggleModalAircraftsDropdown()" class="compact-item">
										<div class="model">{{ a.model }}</div>
										<div class="seats">{{ a.nSeats }} posti</div>
									</li>
								</ul>
							</div>
						</div>
					</div>

					<div *ngIf="addError" class="flights-error">{{addError}}</div>

					<button type="submit" >Conferma</button>
				</form>
			</div>
		</div>
		<div *ngIf="!loading && !filteredFlights.length" class="flights-empty">Nessun volo trovato.</div>
</div>
