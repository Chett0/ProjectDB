<div class="flights-tab">
	<div class="flights-header-row">
		<span class="flights-header-title">Gestione Voli</span>
		<div class="flights-search-box">
			<input type="text" [formControl]="searchControl" placeholder="Cerca..." class="flights-search-input" />
		</div>


	<button class="add-flight-btn" (click)="openAddFlightModal()">+ Aggiungi Volo</button>
	</div>

	<!-- Lista voli -->
		<div class="flights-list" *ngIf="filteredFlights && filteredFlights.length">
		<ul>
			<li *ngFor="let f of filteredFlights" class="flight-row">
				<div class="flight-main">
					<div class="route">
						<span class="route-name">
							{{ (f.route?.departure_airport?.name || f.route?.departure_airport?.city || f.departure_airport?.name || f.departure_airport?.city || '-') }}
							(<span class="code">{{ f.route?.departure_airport?.code || f.departure_airport_code || '-' }}</span>)
							&nbsp;→&nbsp;
							{{ (f.route?.arrival_airport?.name || f.route?.arrival_airport?.city || f.arrival_airport?.name || f.arrival_airport?.city || '-') }}
							(<span class="code">{{ f.route?.arrival_airport?.code || f.arrival_airport_code || '-' }}</span>)
						</span>
					</div>
					<div class="meta">
						<span class="time">{{ formatFlightTime(f.departure_time) }} - {{ formatFlightTime(f.arrival_time) }}</span>
						<span class="aircraft">{{ f.aircraft?.model || f.aircraft_model || '' }}</span>
						<span class="price">€ {{ f.base_price }}</span>
					</div>
				</div>
			</li>
		</ul>
	</div>

		<!-- Modale per aggiunta volo -->
		<div class="modal" *ngIf="showAddFlightModal">
			<div class="modal-content">
				<span class="close" (click)="closeAddFlightModal()">&times;</span>
				<h2>Aggiungi nuovo volo</h2>
					<form (ngSubmit)="onAddFlightSubmit()" #addFlightForm="ngForm">
							<div *ngIf="routesCompact && routesCompact.length" class="modal-route-dropdown-wrapper modal-aircraft-selection">
								<label class="selector-label">Seleziona rotta per il volo</label>
								<div class="modal-selector-toggle" (click)="toggleModalRoutesDropdown()">
									<span *ngIf="!selectedRouteId">Seleziona rotta...</span>
									<span *ngIf="selectedRouteId">{{ selectedRouteLabel }}</span>
									<span class="caret">▾</span>
								</div>
								<div class="modal-dropdown" *ngIf="showModalRoutesDropdown">
									<input type="text" [formControl]="modalRouteSearchControl" placeholder="Cerca rotta..." class="modal-search-input" />
										<div class="modal-aircraft-list">
											<ul>
												<li *ngFor="let r of modalFilteredRoutes" (click)="selectRoute(r.id); toggleModalRoutesDropdown()" class="compact-item">
													<div class="model">
														<ng-container *ngIf="r.name; else showRouteCodes">
															{{ r.name }} ({{ r.departure_airport_code || r.departure_airport?.code || '-' }} → {{ r.arrival_airport_code || r.arrival_airport?.code || '-' }})
														</ng-container>
														<ng-template #showRouteCodes>
															{{ r.departure_airport_code || r.departure_airport?.code || '-' }} → {{ r.arrival_airport_code || r.arrival_airport?.code || '-' }}
														</ng-template>
													</div>
												</li>
											</ul>
										</div>
								</div>
							</div>
					<label for="departure_time">Data e ora partenza:</label>
					<input type="datetime-local" id="departure_time" name="departure_time" [(ngModel)]="newFlight.departure_time" required>

					<label for="arrival_time">Data e ora arrivo:</label>
					<input type="datetime-local" id="arrival_time" name="arrival_time" [(ngModel)]="newFlight.arrival_time" required>

					<label for="base_price">Prezzo base:</label>
					<input type="number" id="base_price" name="base_price" [(ngModel)]="newFlight.base_price" step="0.01" required>
					<div *ngIf="aircraftsCompact && aircraftsCompact.length" class="modal-aircraft-dropdown-wrapper">
						<label class="selector-label">Seleziona aereo per il volo</label>
						<div class="modal-selector-toggle" (click)="toggleModalAircraftsDropdown()">
							<span *ngIf="!selectedAircraftId">Seleziona aereo...</span>
							<span *ngIf="selectedAircraftId">{{ selectedAircraftModel }}</span>
							<span class="caret">▾</span>
						</div>
						<div class="modal-dropdown" *ngIf="showModalAircraftsDropdown">
							<input type="text" [formControl]="modalAircraftSearchControl" placeholder="Cerca aereo..." class="modal-search-input" />
							<div class="modal-aircraft-list">
								<ul>
									<li *ngFor="let a of modalFilteredAircrafts" (click)="selectAircraft(a.id); toggleModalAircraftsDropdown()" class="compact-item">
										<div class="model">{{ a.model }}</div>
										<div class="seats">{{ a.nSeats }} posti</div>
									</li>
								</ul>
							</div>
						</div>
					</div>

					<div *ngIf="addError" class="flights-error">{{addError}}</div>

					<button type="submit"  (click)="addFlight()">Conferma</button>
				</form>
			</div>
		</div>
		<div *ngIf="!loading && !filteredFlights.length" class="flights-empty">Nessun volo trovato.</div>
</div>
