<div class="page">
  <app-header></app-header>

  <main class="body">
    <div class="container">

      <!-- serve per iterare su tutti i voli presenti in base agli scali-->
      <div *ngFor="let flightId of flightIds">
        <div class="ticket-card" *ngIf="flightTickets[flightId]?.flight; else loading">

          <!-- Parte header -->
          <div class="ticket-header">
            <h3>Dettagli Volo</h3>
            <p>
              {{ flightTickets[flightId].flight.departureAirport.city }} ({{
              flightTickets[flightId].flight.departureAirport.code }}) →
              {{ flightTickets[flightId].flight.arrivalAirport.city }} ({{
              flightTickets[flightId].flight.arrivalAirport.code }})
            </p>
          </div>

          <!-- informazioni del volo -->
          <div class="flight-info">
            <div>
              <strong>Partenza:</strong>
              <span>{{ flightTickets[flightId].flight.departureTime }}</span>
            </div>
            <div>
              <strong>Arrivo:</strong>
              <span>{{ flightTickets[flightId].flight.arrivalTime }}</span>
            </div>
          </div>

          <!-- informazioni del passeggero -->
          <div class="passenger-info" *ngIf="passenger; else loadingPassenger">
            <p><strong>Nome:</strong> {{ passenger.name }} {{ passenger.surname }}</p>
          </div>
          <ng-template #loadingPassenger>
            <p>Caricamento informazioni passeggero...</p>
          </ng-template>

          <!-- opzioni per i biglietti -->
          <div class="ticket-options">

            <!-- Seat map -->
            <div class="seat-map">
              <div *ngFor="let seat of getFilteredSeats(flightId)" class="row">
                <button class="seat" [class.selected]="flightTickets[flightId].selectedSeat?.id === seat.id"
                  [class.unavailable]="seat.state !== 'AVAILABLE'"
                  [style.background-color]="ticketColors[seat.aircraftClass.name]"
                  (click)="selectSeat(flightId, seat)">
                </button>
              </div>
            </div>

            <br>
            <div *ngIf="flightTickets[flightId].selectedSeat" class="selection-info">
              Selected Seat: {{ flightTickets[flightId].selectedSeat?.number }}
            </div>

            <!-- Extras -->
            <div class="extras-options">
              <p>Extra:</p>
              <label *ngFor="let extra of flightTickets[flightId].extras" class="extra-item">
                <input type="checkbox" [value]="extra.id" (change)="onExtraChange(flightId, $event)"
                  [checked]="flightTickets[flightId].selectedExtras.includes(extra.id)" />
                {{ extra.name }} (+{{ extra.price }}€)
              </label>
            </div>

          </div>

          <!-- Costo e pulsante acquisto -->
          <div class="ticket-cost">
            <strong>Costo totale:</strong> {{ calculateTotal(flightId) | currency:'EUR':'symbol' }}
          </div>
        </div>



        <ng-template #loading>
          <p>Caricamento volo...</p>
        </ng-template>



        <br>

      </div>

      <!-- è al di fuori di questo div -->
        <button class="buy-btn" (click)="buyTickets()">
          Acquista
        </button>

    </div>
  </main>


  <!-- Modale Successo -->
  <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Biglietto acquistato!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          L'acquisto è stato completato con successo.
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="successRedirect()">Chiudi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modale Errore -->
  <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Errore</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          L'operazione non è riuscita. Riprova più tardi.
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        </div>
      </div>
    </div>
  </div>
  <app-footer></app-footer>
</div>